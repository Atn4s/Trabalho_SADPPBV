<!DOCTYPE html>
<html>

<head>
    <title>Front End</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/blueimp-md5/2.18.0/js/md5.min.js"></script>
    <style>
        #options,
        #loginForm {
            text-align: center;
            width: auto;
            height: auto;
            padding: auto;
        }

        button {
            margin-right: 10px;
        }

        #loginForm img {
            width: auto;
            height: auto;
        }

        /* Estilo para a tabela de usuários */
        #tableUsuarios {
            padding-top: 2%;
            margin: 0 auto; /* Centralizar a tabela horizontalmente */
            border-collapse: collapse; /* Colapsar as bordas das células */
            width: 50%; /* Definir a largura da tabela */
        }

        #tableUsuarios th,
        #tableUsuarios td {
            border: 1px solid black; /* Adicionar borda às células */
            padding: 8px; /* Adicionar preenchimento interno às células */
            text-align: left; /* Alinhar o texto à esquerda dentro das células */
        }

        #tableUsuarios th {
            background-color: #f2f2f2; /* Adicionar cor de fundo para os cabeçalhos */
        }
    </style>
</head>

<body>

    <div id="loginForm">
        <h1> Sistema SADPPBV</h1>
        <h3> Um momento! Confirme suas credenciais para utilizar a plataforma!</h3>
        <img src="password.jpg">
        <form id="login">
            <p> IP do Servidor <input type="text" id="ip" placeholder="192.168.0.0"> </p>
            <p> PORTA do Servidor <input type="text" id="port" placeholder="21000"> </p>
            <p> REGISTRO <input type="text" id="registro" placeholder="1234567890"> </p>
            <p> SENHA <input type="password" id="senha" placeholder="*********"> </p>
            <button type="submit">Login</button> <br>
        </form>
    </div>

    <div id="options" style="display: none;">
        <button id="logoutButton" onclick="fazerLogout()">Logout</button>
        <button id="listUsersButton" onclick="listarUsuarios()">Listar Usuários</button>
        <button id="createUserButton" onclick="criarUsuario()">Cadastrar Usuário</button>
    </div>

    <script>
        let IP = localStorage.getItem('IP');
        let PORT = localStorage.getItem('PORT');
        let token = localStorage.getItem('token');


        if (token) {
            $('#options').css('display', 'block');
            $('#loginForm').css('display', 'none');
        }

        function clearFields() {
            $('#ip').val('');
            $('#port').val('');
            $('#registro').val('');
            $('#senha').val('');
        }

        function clearTable() {
            const table = document.getElementById('tableUsuarios');
            if (table) {
                table.innerHTML = '';
            }
        }


        if (IP && PORT) {
            $('#options').css('display', 'block');
            $('#loginForm').css('display', 'none');
        }

        $('#login').submit(function (event) {
            event.preventDefault();
            IP = $('#ip').val();
            PORT = $('#port').val();

            // Verificar se os campos de IP e PORT não estão vazios
            if (IP && PORT) {
                const registro = $('#registro').val();
                const senha = md5($('#senha').val());

                $.ajax({
                    url: `http://${IP}:${PORT}/login`,
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        registro: registro,
                        senha: senha
                    }),
                    success: function (response) {
                        console.log(response);
                        token = response.token;
                        localStorage.setItem('IP', IP);
                        localStorage.setItem('PORT', PORT);
                        localStorage.setItem('token', token);
                        $('#options').css('display', 'block');
                        $('#loginForm').css('display', 'none');
                    },
                    error: function (error) {
                        console.error(error);
                    }
                });
            } else {
                // Lidar com campos vazios
                console.error("IP e PORT devem ser preenchidos");
            }
        });


        function fazerLogout() {
            $.ajax({
                url: `http://${IP}:${PORT}/logout`,
                type: 'POST',
                contentType: 'application/json',
                headers: {
                    'Authorization': `Bearer ${token}`
                },
                success: function (response) {
                    console.log(response);
                    clearFields();
                    clearTable(); // Limpa a tabela de usuários ao fazer logout
                    localStorage.removeItem('token'); // Remova o token do localStorage ao fazer logout
                    localStorage.removeItem('IP'); // Remova o IP do localStorage ao fazer logout
                    localStorage.removeItem('PORT'); // Remova o PORT do localStorage ao fazer logout
                    $('#options').css('display', 'none');
                    $('#loginForm').css('display', 'block');
                },
                error: function (error) {
                    console.error(error);
                }
            });
        }

        let tableVisible = false; // Variável para controlar a visibilidade da tabela
        let table; // Variável para a tabela

        function toggleTable(show) {
            table = document.getElementById('tableUsuarios');
            if (show) {
                table.style.display = 'block'; // Mostra a tabela
                tableVisible = true;
            } else {
                table.style.display = 'none'; // Esconde a tabela
                tableVisible = false;
            }
        }

        function listarUsuarios() {
        $.ajax({
            url: `http://${IP}:${PORT}/usuarios`,
            type: 'GET',
            contentType: 'application/json',
            headers: {
                'Authorization': `Bearer ${token}`
            },
            success: function (response) {
                console.log(response);
                if (response && (response.usuarios || response.usuario)) {
                    const usuarios = response.usuarios ? response.usuarios : [response.usuario]; // Verifica se há vários usuários ou apenas um

                    clearTable(); // Limpa a tabela antes de adicionar novos dados

                    table = document.getElementById('tableUsuarios');
                    if (!table) {
                        table = document.createElement('table');
                        table.id = 'tableUsuarios';
                        document.body.appendChild(table);
                    }

                    const tableBody = document.createElement('tbody');
                    for (let i = 0; i < usuarios.length; i++) {
                        const usuario = usuarios[i];
                        const row = tableBody.insertRow(i);

                        const cell1 = row.insertCell(0);
                        cell1.innerHTML = usuario.nome;

                        const cell2 = row.insertCell(1);
                        cell2.innerHTML = usuario.registro;

                        const cell3 = row.insertCell(2);
                        cell3.innerHTML = usuario.email;

                        const cell4 = row.insertCell(3);
                        cell4.innerHTML = usuario.tipo_usuario === 1 ? 'Administrador' : 'Usuário Comum';
                    }
                    table.appendChild(tableBody);
                    toggleTable(true); // Sempre mostra a tabela quando os usuários são listados
                } else {
                    console.error("Nenhum usuário encontrado.");
                }
            },
            error: function (error) {
                console.error(error);
            }
        });
    }

    function criarUsuario() {
        $.ajax({
            url: `http://${IP}:${PORT}/usuarios`,
            type: 'GET',
            contentType: 'application/json',
            headers: {
                'Authorization': `Bearer ${token}`
            },
            success: function (response) {
                console.log(response);
                if (response && response.usuarios) {
                    const usuarios = response.usuarios;
                    const usuarioLogado = usuarios.find(user => user.id === 1); // Altere o ID para o ID do usuário logado

                    if (usuarioLogado && usuarioLogado.tipo_usuario === 1) {
                        const nome = prompt('Digite o nome do usuário:');
                        const registro = prompt('Digite o registro do usuário:');
                        const email = prompt('Digite o e-mail do usuário:');
                        const senha = prompt('Digite a senha do usuário:');
                        const tipo_usuario = prompt('Digite o tipo de usuário (1 para administrador, 0 para usuário comum):');

                        const novoUsuario = {
                            nome: nome,
                            registro: registro,
                            email: email,
                            senha: senha,
                            tipo_usuario: parseInt(tipo_usuario)
                        };

                        $.ajax({
                            url: `http://${IP}:${PORT}/usuarios`,
                            type: 'POST',
                            contentType: 'application/json',
                            headers: {
                                'Authorization': `Bearer ${token}`
                            },
                            data: JSON.stringify(novoUsuario),
                            success: function (response) {
                                console.log(response);
                            },
                            error: function (error) {
                                console.error(error);
                            }
                        });
                    } else {
                        alert("Apenas administradores podem cadastrar usuários.");
                    }
                } else {
                    alert("Apenas administradores podem cadastrar usuários.");
                }
            },
            error: function (error) {
                console.error(error);
            }
        });
    }

    </script>

</body>

</html>
